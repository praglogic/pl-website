---
import Layout from '../../layouts/Layout.astro';
import { Cpu, DollarSign } from 'lucide-astro';
---

<Layout title="Confidential Documents | Pragmatic Logic">
  <div id="loading-state" class="loading-container">
    <div class="loading-card">
      <div class="spinner"></div>
      <p>Verifying access...</p>
    </div>
  </div>

  <div id="access-denied" class="access-denied-container hidden">
    <div class="access-denied-card">
      <div class="denied-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
        </svg>
      </div>
      <h1>Access Denied</h1>
      <p id="denied-reason">You must sign in and accept the confidentiality agreement to view these documents.</p>
      <div class="denied-actions">
        <a href="/auth/signin" class="btn-primary">Sign In</a>
        <a href="/" class="btn-secondary">Return Home</a>
      </div>
    </div>
  </div>

  <div id="documents-container" class="documents-container hidden">
    <div class="documents-header">
      <div class="header-content">
        <a href="/" class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
          </svg>
          Back to Pragmatic Logic
        </a>
        <div class="user-info">
          <span id="user-email"></span>
          <button id="signout-btn" class="btn-signout">Sign Out</button>
        </div>
      </div>
    </div>

    <div class="documents-content">
      <div class="documents-card">
        <div class="card-header">
          <div class="success-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>NDA Accepted</span>
          </div>
          <h1>Confidential Documents</h1>
          <p class="subtitle">Select a document to view. All access is logged for security purposes.</p>
        </div>

        <div class="documents-grid">
          <a href="/confidential/architecture" class="document-card">
            <div class="doc-icon architecture">
              <Cpu size={28} />
            </div>
            <div class="doc-content">
              <h3>Technical Architecture Brief</h3>
              <p>Complete Lilo Engine architecture, 7 AI agents, infrastructure details, and security specifications.</p>
            </div>
            <span class="doc-arrow">→</span>
          </a>

          <a href="/confidential/business" class="document-card">
            <div class="doc-icon business">
              <DollarSign size={28} />
            </div>
            <div class="doc-content">
              <h3>Executive Brief</h3>
              <p>Business overview, market analysis, competitive landscape, and investment opportunity.</p>
            </div>
            <span class="doc-arrow">→</span>
          </a>
        </div>

        <p class="security-note">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Documents are confidential. Do not share or distribute.
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  const loadingState = document.getElementById('loading-state') as HTMLDivElement;
  const accessDenied = document.getElementById('access-denied') as HTMLDivElement;
  const deniedReason = document.getElementById('denied-reason') as HTMLParagraphElement;
  const documentsContainer = document.getElementById('documents-container') as HTMLDivElement;
  const userEmailSpan = document.getElementById('user-email') as HTMLSpanElement;
  const signoutBtn = document.getElementById('signout-btn') as HTMLButtonElement;

  async function verifyAccess() {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      loadingState.classList.add('hidden');
      deniedReason.textContent = 'You must sign in to view these documents.';
      accessDenied.classList.remove('hidden');
      return;
    }

    // Check if user has accepted confidentiality agreement
    const { data: agreement, error } = await supabase
      .from('confidentiality_agreements')
      .select('*')
      .eq('user_id', session.user.id)
      .single();

    if (!agreement || error) {
      loadingState.classList.add('hidden');
      deniedReason.textContent = 'You must accept the confidentiality agreement to view these documents.';
      accessDenied.classList.remove('hidden');
      
      const agreementLink = document.createElement('a');
      agreementLink.href = '/confidential/agreement';
      agreementLink.className = 'btn-primary';
      agreementLink.textContent = 'View Agreement';
      
      const actionsDiv = document.querySelector('.denied-actions');
      if (actionsDiv) {
        actionsDiv.innerHTML = '';
        actionsDiv.appendChild(agreementLink);
      }
      return;
    }

    // Access granted - show documents
    loadingState.classList.add('hidden');
    documentsContainer.classList.remove('hidden');
    userEmailSpan.textContent = session.user.email || '';
  }

  signoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  });

  verifyAccess();
</script>

<style>
  .loading-container,
  .access-denied-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
    padding: var(--space-4);
  }

  .loading-card,
  .access-denied-card {
    background: white;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    padding: var(--space-10);
    text-align: center;
    max-width: 400px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--color-border-light);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-4);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-card p {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .hidden {
    display: none !important;
  }

  .denied-icon {
    color: var(--color-error);
    margin-bottom: var(--space-4);
  }

  .access-denied-card h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-3);
  }

  .access-denied-card p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .denied-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    color: white;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
    transition: all var(--duration-normal) var(--ease-out);
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
    color: white;
  }

  .btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: white;
    color: var(--color-text);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    border: 1px solid var(--color-border);
    transition: all var(--duration-normal) var(--ease-out);
  }

  .btn-secondary:hover {
    background: var(--color-background-secondary);
  }

  .documents-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
  }

  .documents-header {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--color-border-light);
    padding: var(--space-3) var(--space-6);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
  }

  .back-link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: var(--font-size-sm);
    transition: color var(--duration-fast);
  }

  .back-link:hover {
    color: var(--color-text);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  #user-email {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .btn-signout {
    background: var(--color-background-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--duration-fast);
  }

  .btn-signout:hover {
    background: var(--color-border-light);
  }

  .documents-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
  }

  .documents-card {
    background: white;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    padding: var(--space-10);
    width: 100%;
    max-width: 700px;
  }

  .card-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .success-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-4);
  }

  .card-header h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--space-2);
  }

  .subtitle {
    color: var(--color-text-secondary);
    margin: 0;
  }

  .documents-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .document-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-background-secondary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .document-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .doc-icon {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .doc-icon.architecture {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1d4ed8;
  }

  .doc-icon.business {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #059669;
  }

  .doc-content {
    flex: 1;
  }

  .doc-content h3 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-1);
    color: var(--color-text);
  }

  .doc-content p {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: 1.5;
  }

  .doc-arrow {
    font-size: var(--font-size-xl);
    color: var(--color-text-tertiary);
    opacity: 0;
    transform: translateX(-8px);
    transition: all 0.2s ease;
  }

  .document-card:hover .doc-arrow {
    opacity: 1;
    transform: translateX(0);
  }

  .security-note {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    margin: 0;
  }

  @media (max-width: 640px) {
    .documents-card {
      padding: var(--space-6);
    }

    .document-card {
      flex-direction: column;
      text-align: center;
    }

    .doc-arrow {
      display: none;
    }
  }
</style>
